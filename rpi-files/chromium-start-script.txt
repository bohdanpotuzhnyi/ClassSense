#!/usr/bin/env bash

CONFIG="/home/thrombus77/files/config.ini"

# Wait for Python client to write a non-empty class_pin.
# Try for up to 60 seconds.
PIN=""
for i in $(seq 1 60); do
  if [ -f "$CONFIG" ]; then
    PIN=$(awk -F '=' '
      BEGIN { in_server=0 }
      /^\[server\]/ { in_server=1; next }
      /^\[/ { in_server=0 }
      in_server && $1 ~ /class_pin/ {
        gsub(/[ \t]/, "", $2);
        print $2;
        exit
      }' "$CONFIG")
  fi

  if [ -n "$PIN" ]; then
    break
  fi

  sleep 1
done

BASE_URL="https://classsense.potuzhnyi.com/teacher"

if [ -n "$PIN" ]; then
  URL="${BASE_URL}?pin=${PIN}"
else
  URL="${BASE_URL}"
fi

exec chromium-browser \
  "$URL" \
  --kiosk \
  --noerrdialogs \
  --disable-infobars \
  --disable-session-crashed-bubble \
  --start-maximized \
  --password-store=basic \
  --disable-features=UsePasswordManager